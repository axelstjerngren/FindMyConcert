{% extends 'concert/base.html' %}
{% load staticfiles %} 

{% block title_block %} {{ block.super }} {% endblock %}

{% block body_block %}


<div class="container">
    <div class="row">
        <div class ="col-lg-6 col-xs-12  col-md-12">
            <br>
            <h1>{{ concert.artist}} at {{ concert.venue.venue_name }}</h1>
            <p>{{ concert.venue.venue_name }} , {{ concert.venue.location }}<br>
            {{ concert.start_time }} - {{ concert.end_time }}   {{ concert.date }}</p>
            <p><a href="{{ concert.url}}">Tickets</a>  <span class="fa fa-star checked"></span>
                <span class="fa fa-star checked"></span>
                <span class="fa fa-star checked"></span>
                <span class="fa fa-star"></span>
                <span class="fa fa-star"></span> <button class="btn btn-outline-success navbar-right pull-right" onclick="bookmark({{ concert.concertID }})" >Bookmark</button></p>

            <img class = "img-fluid" src="{{ concert.image.url }}">
            <br>
            <br>
            <h2>{{ concert.artist }}  
            </h2>
            <p>{{ concert.description }}</p>
            <br>
            <br>

        </div>


        <div class ="col-lg-6 col-xs-12 col-md-12">
            <!-- Bootstrap tabs start -->
            <ul class="nav nav-tabs">

                <li class="nav-item"> 
                    <a class="nav-link active" data-toggle="tab" href="#comments" role="tab" aria-selected="true">Comments</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#going" role="tab" aria-selected="true">{% if concert.is_future %} Going {% else %} Went {% endif %}</a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link " data-toggle="tab" href="#venue" role="tab" aria-selected="true">Venue</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link " data-toggle="tab" href="#spotify" role="tab" aria-selected="true">Spotify</a>
                </li>
            </ul>
            <!-- Bootstrap tabs end -->

            <div class="tab-content"> <!-- This is where the content for the different tabs are defined -->

                <div id="spotify" class="tab-pane fade"> <!-- This tab contains a venue description -->
                    <br>
                    <iframe src="https://open.spotify.com/embed/artist/{{concert.spotify_URI}}" width="370" height="500" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                </div>

                <div id="venue" class="tab-pane fade"> <!-- This tab contains a venue description -->
                    <br>
                    <h2>{{ concert.venue.venue_name }}</h2>
                    <img class = "img-fluid "src="{{ concert.venue.image.url }}">
                    <p>{{ concert.venue.description }}</p>
                </div>

                <div id="going" class="tab-pane fade show"> <!-- This shows all users who have bookmarked the concert-->
                    <br>
                    {% if concert.bookmarks.all  %}
                    {% for giggoer in concert.bookmarks.all %}
                    <p >{{ giggoer.user.username }}</p>
                    {% endfor %}
                    {% else%}
                    <p> There are no other users currently intrested in this concert</p>
                    {% endif %}
                </div>
                
                <div id="comments" class="tab-pane fade show active"> <!-- This tab shows the comments associated to the concert -->
                    <br>
                    <h2> Comments</h2>
                    <div class="col-md-6 col-md-offset-2 col-sm-12 col-lg-12">
                        <div>
                            <div class="panel panel-info">
                                <div class="panel-heading">
                                </div>
                                <div class="panel-body"> 
                                    <!-- Comment input area start -->
                                    {% if user.is_authenticated %}
                                    <form method="post">{% csrf_token %}
                                        <textarea id = "commentbox" class="form-control" placeholder="write a comment..." rows="3"></textarea>
                                        <br>
                                        <button type="button" class="btn btn-info pull-right" id = "postcomment" >Post</button>
                                        <hr>
                                    </form>
                                    {% endif %}
                                    <!-- Comment input are end --> 

                                    <!-- Section for all the comments, show all comments associated with this conncert -->
                                    <ul class = "comments" id ="allcomments">
                                        {% for comment in concert.comment.all%}
                                        <li class="media">
                                            <a href="{ % url 'profile' comment.user.username‰}" class="pull-left">
                                                {% if comment.user.is_venue and comment.user.venue.image != "" %}
                                                <img src="{{ comment.user.venue.image.url }}" alt="Avatar" class="avatar">
                                                {% elif not comment.user.is_venue and comment.user.giggoer.image != "" %}
                                                <img src="{{comment.user.giggoer.image.url }}" alt="Avatar" class="avatar">
                                                {% else %}
                                                <i class="far fa-user fa-lg"></i>
                                                {% endif %}
                                            </a> <!-- Handle profile pic and wrap in link to profile -->


                                            <div class="media-body"> <!-- Comment body starts here -->
                                                <a href="{ % url 'profile' comment.user.username ‰}"><strong class="text-success">{{comment.user.username}}</strong><a>
                                                    <p>
                                                        {{ comment.text }}
                                                    </p>

                                                        <!-- Todo, implement delete
                                                        {% if comment.user.username == user.username %}
                                                        <a href = # class = "text-muted" >Delete</a>
                                                        {% endif %}
                                                    -->
                                                </div>
                                            </li>
                                            {% endfor %}       
                                        </ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div> 

    <script>

       document.getElementById("postcomment").addEventListener("click", postcomment);


       function postcomment() {

        //MAake AJAX post request
        $.ajaxSetup({
            headers: { "X-CSRFToken": '{{csrf_token}}' }
        });
        $.ajax({
            type: 'POST',
            url:'http://127.0.0.1:8000/api/postcomment/',
            data: {'data':$('#commentbox').val(),'id':'{{concert.concertID}}'},
            credentials: 'include',
            dataType: 'json',
            success:function(data){
                var $text = $('#commentbox').val();
                toastr.success('Comment posted succesfully');
                    $("#commentbox").val(''); //Clear the comment box


                    //Next part is a mess, this appens the new comment to the html code
                    //The links are left blank deliberately for the sake of simplicity and time constraints
                    //The user will have to relaod to access more fucntions
                    $('<li class="media">').append(
                        $('<a href="#" class="pull-left"><img src="' +data.image+'" class="avatar"></a>'),
                        $('<div class="media-body"><a href="#"<strong class="text-success">'+data.username +'</strong></a><p>' +$text +'</p>')
                        ).appendTo('#allcomments');             
                },

                error: function(data) {
                    toastr.error('Comment not sent!');
                }


            });



        
    };


</script>

{% endblock %}